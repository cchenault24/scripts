#!/bin/zsh
#
# plugins/development/node_modules.sh - Node.js module caches cleanup plugin
#

set -euo pipefail  # Exit on error, undefined vars, pipe failures

clean_node_modules() {
  print_header "Cleaning Node.js Module Caches"
  
  print_warning "⚠️ CAUTION: This will clean Node.js module caches."
  print_warning "Cleaning node_modules directories requires re-running npm/yarn install."
  
  local total_space_freed=0
  
  # Clean global node_modules cache locations
  local node_paths=(
    "$HOME/.node_modules"
    "$HOME/.npm-global"
  )
  
  for node_path in "${node_paths[@]}"; do
    if [[ -d "$node_path" ]]; then
      local space_before=$(calculate_size_bytes "$node_path")
      if ! backup "$node_path" "node_$(basename "$node_path")"; then
        print_error "Backup failed for $node_path. Aborting cleanup to prevent data loss."
        log_message "ERROR" "Backup failed for $node_path, aborting"
        return 1
      fi
      
      safe_clean_dir "$node_path" "Node.js $(basename "$node_path")" || {
        print_error "Failed to clean $node_path"
        return 1
      }
      
      local space_after=$(calculate_size_bytes "$node_path")
      local space_freed=$((space_before - space_after))
      # Validate space_freed is not negative (directory may have grown during cleanup)
      if [[ $space_freed -lt 0 ]]; then
        space_freed=0
        log_message "WARNING" "Directory size increased during cleanup: $node_path (before: $(format_bytes $space_before), after: $(format_bytes $space_after))"
      fi
      total_space_freed=$((total_space_freed + space_freed))
      print_success "Cleaned $node_path."
    fi
  done
  
  # Optional: Clean node_modules in common locations (with strong warning)
  if [[ "$MC_DRY_RUN" != "true" ]] && mc_confirm "Do you want to clean node_modules directories? (WARNING: Requires re-install)"; then
    print_warning "Searching for node_modules directories (this may take a while)..."
    
    # Limit search to common project locations to avoid taking too long
    local search_paths=(
      "$HOME/Projects"
      "$HOME/Development"
      "$HOME/workspace"
      "$HOME/Documents"
    )
    
    local found_count=0
    for search_path in "${search_paths[@]}"; do
      if [[ -d "$search_path" ]]; then
        find "$search_path" -type d -name "node_modules" -maxdepth 5 2>/dev/null | while read node_modules_dir; do
          if [[ -d "$node_modules_dir" ]]; then
            found_count=$((found_count + 1))
            local parent_dir=$(dirname "$node_modules_dir")
            local project_name=$(basename "$parent_dir")
            local size=$(calculate_size "$node_modules_dir")
            
            if mc_confirm "Clean node_modules in $project_name ($size)?"; then
              local space_before=$(calculate_size_bytes "$node_modules_dir")
              if ! backup "$node_modules_dir" "node_modules_${project_name}"; then
                print_error "Backup failed for node_modules in $project_name. Skipping this directory."
                log_message "ERROR" "Backup failed for node_modules in $project_name, skipping"
                continue
              fi
              safe_remove "$node_modules_dir" "node_modules in $project_name"
              # safe_remove already tracks space, but we need to track it for this plugin
              # space_freed equals space_before since the directory is removed
              local space_freed=$space_before
              total_space_freed=$((total_space_freed + space_freed))
              print_success "Cleaned node_modules in $project_name."
              log_message "SUCCESS" "Cleaned node_modules: $node_modules_dir (freed $(format_bytes $space_freed))"
            fi
          fi
        done
      fi
    done
    
    if [[ $found_count -eq 0 ]]; then
      print_info "No node_modules directories found in common locations."
    fi
  fi
  
  if [[ $total_space_freed -eq 0 ]]; then
    print_warning "No Node.js module caches found to clean."
    track_space_saved "Node.js Modules" 0
  else
    # safe_clean_dir/safe_remove already update MC_TOTAL_SPACE_SAVED, so we only track per-operation
    track_space_saved "Node.js Modules" $total_space_freed "true"
    print_warning "You may need to run 'npm install' or 'yarn install' in affected projects."
  fi
  
  return 0
}

# Size calculation function for sweep
_calculate_node_modules_size_bytes() {
  local size_bytes=0
  local node_size=0
  if [[ -d "$HOME/.node_modules" ]]; then
    local node_modules_size=$(calculate_size_bytes "$HOME/.node_modules" 2>/dev/null || echo "0")
    [[ "$node_modules_size" =~ ^[0-9]+$ ]] && node_size=$((node_size + node_modules_size))
  fi
  if [[ -d "$HOME/.npm-global" ]]; then
    local npm_global_size=$(calculate_size_bytes "$HOME/.npm-global" 2>/dev/null || echo "0")
    [[ "$npm_global_size" =~ ^[0-9]+$ ]] && node_size=$((node_size + npm_global_size))
  fi
  size_bytes=$node_size
  echo "$size_bytes"
}

# Register plugin with size function
register_plugin "Node.js Modules" "development" "clean_node_modules" "false" "_calculate_node_modules_size_bytes"
