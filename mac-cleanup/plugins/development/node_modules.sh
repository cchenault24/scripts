#!/bin/zsh
#
# plugins/development/node_modules.sh - Node.js module caches cleanup plugin
#

clean_node_modules() {
  print_header "Cleaning Node.js Module Caches"
  
  print_warning "⚠️ CAUTION: This will clean Node.js module caches."
  print_warning "Cleaning node_modules directories requires re-running npm/yarn install."
  
  local total_space_freed=0
  
  # Clean global node_modules cache locations
  local node_paths=(
    "$HOME/.node_modules"
    "$HOME/.npm-global"
  )
  
  for node_path in "${node_paths[@]}"; do
    if [[ -d "$node_path" ]]; then
      local space_before=$(calculate_size_bytes "$node_path")
      backup "$node_path" "node_$(basename "$node_path")"
      safe_clean_dir "$node_path" "Node.js $(basename "$node_path")"
      local space_after=$(calculate_size_bytes "$node_path")
      local space_freed=$((space_before - space_after))
      # Validate space_freed is not negative (directory may have grown during cleanup)
      if [[ $space_freed -lt 0 ]]; then
        space_freed=0
        log_message "WARNING" "Directory size increased during cleanup: $node_path (before: $(format_bytes $space_before), after: $(format_bytes $space_after))"
      fi
      total_space_freed=$((total_space_freed + space_freed))
      print_success "Cleaned $node_path."
    fi
  done
  
  # Optional: Clean node_modules in common locations (with strong warning)
  if [[ "$MC_DRY_RUN" != "true" ]] && mc_confirm "Do you want to clean node_modules directories? (WARNING: Requires re-install)"; then
    print_warning "Searching for node_modules directories (this may take a while)..."
    
    # Limit search to common project locations to avoid taking too long
    local search_paths=(
      "$HOME/Projects"
      "$HOME/Development"
      "$HOME/workspace"
      "$HOME/Documents"
    )
    
    local found_count=0
    for search_path in "${search_paths[@]}"; do
      if [[ -d "$search_path" ]]; then
        find "$search_path" -type d -name "node_modules" -maxdepth 5 2>/dev/null | while read node_modules_dir; do
          if [[ -d "$node_modules_dir" ]]; then
            found_count=$((found_count + 1))
            local parent_dir=$(dirname "$node_modules_dir")
            local project_name=$(basename "$parent_dir")
            local size=$(calculate_size "$node_modules_dir")
            
            if mc_confirm "Clean node_modules in $project_name ($size)?"; then
              local space_before=$(calculate_size_bytes "$node_modules_dir")
              if ! backup "$node_modules_dir" "node_modules_${project_name}"; then
                print_error "Backup failed for node_modules in $project_name. Skipping this directory."
                log_message "ERROR" "Backup failed for node_modules in $project_name, skipping"
                continue
              fi
              safe_remove "$node_modules_dir" "node_modules in $project_name"
              # safe_remove already tracks space, but we need to track it for this plugin
              # space_freed equals space_before since the directory is removed
              local space_freed=$space_before
              total_space_freed=$((total_space_freed + space_freed))
              print_success "Cleaned node_modules in $project_name."
              log_message "SUCCESS" "Cleaned node_modules: $node_modules_dir (freed $(format_bytes $space_freed))"
            fi
          fi
        done
      fi
    done
    
    if [[ $found_count -eq 0 ]]; then
      print_info "No node_modules directories found in common locations."
    fi
  fi
  
  if [[ $total_space_freed -eq 0 ]]; then
    print_warning "No Node.js module caches found to clean."
  else
    # safe_clean_dir/safe_remove already update MC_TOTAL_SPACE_SAVED, so we only update plugin-specific tracking
    MC_SPACE_SAVED_BY_OPERATION["Node.js Modules"]=$total_space_freed
    # Write to space tracking file if in background process (with locking)
    if [[ -n "${MC_SPACE_TRACKING_FILE:-}" && -f "$MC_SPACE_TRACKING_FILE" ]]; then
      _write_space_tracking_file "Node.js Modules" "$total_space_freed"
    fi
    print_warning "You may need to run 'npm install' or 'yarn install' in affected projects."
  fi
}

# Register plugin
register_plugin "Node.js Modules" "development" "clean_node_modules" "false"
